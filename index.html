<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Claude Chat</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet"/>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
--bg:#09090b;--sf:#111114;--sf2:#18181d;--sf3:#222230;
--sb-bg:#0c0c0f;--sb-hov:#161620;--sb-act:#1c1c2c;
--bdr:rgba(255,255,255,.06);--bdr2:rgba(255,255,255,.1);
--tx:#ededf2;--tx2:#9494a8;--tx3:#5e5e72;
--ac:#8b7cf6;--ac-g:rgba(139,124,246,.15);--ac2:#a78bfa;
--ubg:linear-gradient(135deg,#1a1730,#1f1b38);--ubd:rgba(139,124,246,.18);
--abg:linear-gradient(135deg,#121215,#141418);--abd:rgba(255,255,255,.04);
--tbg:rgba(139,124,246,.04);--tbd:rgba(139,124,246,.25);
--grn:#4ade80;--yel:#facc15;--red:#f87171;
--r:14px;--rs:10px;--sw:280px;--nw:38px;
}
html,body{height:100%;font-family:'Inter',-apple-system,sans-serif;background:var(--bg);color:var(--tx);overflow:hidden;-webkit-font-smoothing:antialiased}

.app{display:flex;height:100dvh;width:100%}

/* ‚ïê‚ïê‚ïê SIDEBAR ‚ïê‚ïê‚ïê */
.sidebar{width:var(--sw);min-width:var(--sw);background:var(--sb-bg);border-right:1px solid var(--bdr);display:flex;flex-direction:column;z-index:100;transition:transform .3s cubic-bezier(.4,0,.2,1)}
.sb-hd{padding:14px;border-bottom:1px solid var(--bdr);display:flex;flex-direction:column;gap:10px}
.sb-br{display:flex;align-items:center;gap:9px}
.sb-logo{width:30px;height:30px;background:linear-gradient(135deg,var(--ac),var(--ac2));border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:14px;box-shadow:0 2px 12px var(--ac-g);flex-shrink:0}
.sb-ti{font-size:15px;font-weight:700;letter-spacing:-.3px}
.btn-nw{width:100%;padding:9px 14px;border:1px dashed var(--bdr2);border-radius:var(--rs);background:0 0;color:var(--tx2);font:500 12.5px/1 'Inter',sans-serif;cursor:pointer;transition:.2s;display:flex;align-items:center;gap:7px}
.btn-nw:hover{background:var(--sb-hov);color:var(--tx);border-color:var(--ac)}
.sb-ls{flex:1;overflow-y:auto;padding:6px}
.sb-ls::-webkit-scrollbar{width:3px}.sb-ls::-webkit-scrollbar-thumb{background:rgba(255,255,255,.06);border-radius:2px}
.sb-dt{padding:10px 8px 4px;font-size:9.5px;font-weight:600;text-transform:uppercase;letter-spacing:.8px;color:var(--tx3)}
.sb-it{display:flex;align-items:center;gap:8px;padding:9px 10px;border-radius:var(--rs);cursor:pointer;transition:.15s;margin-bottom:1px;border:1px solid transparent;position:relative}
.sb-it:hover{background:var(--sb-hov)}.sb-it.act{background:var(--sb-act);border-color:var(--bdr2)}
.sb-ic{width:26px;height:26px;border-radius:7px;background:var(--sf3);display:flex;align-items:center;justify-content:center;font-size:11px;flex-shrink:0}
.sb-bd{flex:1;min-width:0}
.sb-tt{font-size:12px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.sb-mt{font-size:10px;color:var(--tx3);margin-top:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.sb-dl{opacity:0;width:22px;height:22px;border:none;background:var(--sf3);color:var(--tx3);border-radius:5px;font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:.15s;flex-shrink:0}
.sb-it:hover .sb-dl{opacity:1}.sb-dl:hover{background:rgba(248,113,113,.15);color:var(--red)}
.sb-ov{display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:99;backdrop-filter:blur(4px)}

/* ‚ïê‚ïê‚ïê MAIN ‚ïê‚ïê‚ïê */
.main{flex:1;display:flex;flex-direction:column;min-width:0}
.hdr{display:flex;align-items:center;gap:10px;padding:10px 18px;background:var(--sf);border-bottom:1px solid var(--bdr);z-index:10;flex-wrap:wrap}
.hamburger{display:none;background:var(--sf2);border:1px solid var(--bdr);color:var(--tx);width:34px;height:34px;border-radius:8px;font-size:15px;cursor:pointer;align-items:center;justify-content:center;flex-shrink:0}
.sel-w{position:relative;flex:1;min-width:150px;max-width:400px}
#modSel{width:100%;appearance:none;background:var(--sf2);color:var(--tx);border:1px solid var(--bdr2);border-radius:var(--rs);padding:8px 34px 8px 12px;font:500 11.5px/1.3 'Inter',sans-serif;cursor:pointer;outline:0;transition:.25s}
#modSel:hover{border-color:rgba(255,255,255,.15)}#modSel:focus{border-color:var(--ac);box-shadow:0 0 0 3px var(--ac-g)}
#modSel option{background:var(--sf2);color:var(--tx)}
.sel-w::after{content:'';position:absolute;right:12px;top:50%;transform:translateY(-50%);border:4px solid transparent;border-top:5px solid var(--tx2);pointer-events:none}
.hdr-r{display:flex;align-items:center;gap:10px;margin-left:auto}
.price{font-size:10.5px;font-weight:500;display:flex;gap:5px;align-items:center}
.price .pi{color:var(--grn)}.price .po{color:var(--yel)}.price .sp{color:var(--tx3)}
.cost-b{font-size:10px;font-weight:600;color:var(--ac);background:var(--ac-g);padding:3px 9px;border-radius:20px;white-space:nowrap}

/* ‚ïê‚ïê‚ïê AUTO-CONTINUE TOGGLE ‚ïê‚ïê‚ïê */
.ac-toggle{display:flex;align-items:center;gap:5px;cursor:pointer;font-size:10.5px;color:var(--tx2);user-select:none;white-space:nowrap;flex-shrink:0}
.ac-toggle input{accent-color:var(--ac);width:13px;height:13px;margin:0;cursor:pointer}
.ac-toggle:hover{color:var(--tx)}

/* ‚ïê‚ïê‚ïê CHAT WRAPPER ‚ïê‚ïê‚ïê */
.chat-w{display:flex;flex:1;overflow:hidden;position:relative}

/* ‚ïê‚ïê‚ïê CHAT AREA ‚ïê‚ïê‚ïê */
#chatArea{flex:1;overflow-y:auto;padding:20px 14px;display:flex;flex-direction:column;gap:6px;scroll-behavior:smooth}
#chatArea::-webkit-scrollbar{width:5px}#chatArea::-webkit-scrollbar-track{background:0 0}#chatArea::-webkit-scrollbar-thumb{background:rgba(255,255,255,.07);border-radius:3px}

.empty{display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;text-align:center;gap:12px;color:var(--tx3);padding:40px}
.empty-ic{width:52px;height:52px;background:var(--sf2);border:1px solid var(--bdr);border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:22px}
.empty-h{font-size:15px;font-weight:600;color:var(--tx2)}
.empty-p{font-size:12px;max-width:280px;line-height:1.6}

.msg-row{display:flex;flex-direction:column;max-width:780px;width:100%;margin:0 auto;animation:fadeUp .3s ease-out}
@keyframes fadeUp{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.msg{padding:16px 20px;border-radius:var(--r);line-height:1.72;font-size:13.5px;word-wrap:break-word;position:relative}
.msg.user{background:var(--ubg);border:1px solid var(--ubd);border-bottom-right-radius:4px}
.msg.assistant{background:var(--abg);border:1px solid var(--abd);border-bottom-left-radius:4px}
.msg-hdr{display:flex;align-items:center;gap:7px;margin-bottom:8px}
.msg-av{width:22px;height:22px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:10px;flex-shrink:0}
.msg.user .msg-av{background:linear-gradient(135deg,#6366f1,#8b5cf6)}
.msg.assistant .msg-av{background:linear-gradient(135deg,#f59e0b,#ef4444)}
.msg-nm{font-size:10.5px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--tx2)}
.msg.user .msg-nm{color:#a78bfa}
.msg-ml{font-size:10px;color:var(--tx3);font-weight:400;letter-spacing:0;text-transform:none}
.msg-tm{font-size:9.5px;color:var(--tx3);margin-left:auto}
.msg-body{white-space:pre-wrap}.msg-body.md{white-space:normal}
.err-text{color:var(--red)}

/* ‚ïê‚ïê‚ïê COPY RESPONSE BUTTON ‚ïê‚ïê‚ïê */
.cp-resp-btn{background:var(--sf3);border:1px solid var(--bdr);color:var(--tx3);padding:3px 10px;border-radius:6px;font:500 10px/1 'Inter',sans-serif;cursor:pointer;transition:.2s;display:inline-flex;align-items:center;gap:4px;margin-left:8px;white-space:nowrap;flex-shrink:0}
.cp-resp-btn:hover{color:var(--tx);background:var(--sb-hov);border-color:var(--bdr2)}
.cp-resp-btn.copied{color:var(--grn);border-color:rgba(74,222,128,.25);background:rgba(74,222,128,.06)}

/* ‚ïê‚ïê‚ïê THINKING ‚ïê‚ïê‚ïê */
.think{margin-bottom:14px;border-radius:var(--rs);border:1px solid var(--tbd);background:var(--tbg);overflow:hidden;border-left:3px solid var(--ac)}
.think-hd{display:flex;align-items:center;gap:8px;padding:10px 14px;cursor:pointer;user-select:none;transition:.15s}
.think-hd:hover{background:rgba(139,124,246,.06)}
.think-ic{width:22px;height:22px;background:linear-gradient(135deg,var(--ac),var(--ac2));border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:10px;flex-shrink:0}
.think-lb{font-size:12px;font-weight:600;color:var(--ac);flex:1}
.think-mt{font-size:10px;color:var(--tx3);font-weight:500}
.think-ch{font-size:9px;color:var(--tx3);transition:transform .25s;display:inline-block}
.think.open .think-ch{transform:rotate(90deg)}
.think-bd{overflow:hidden;transition:max-height .35s cubic-bezier(.4,0,.2,1),opacity .3s;max-height:0;opacity:0}
.think.open .think-bd{max-height:800px;opacity:1}
.think-tx{padding:0 14px 14px;font-size:12px;color:var(--tx3);white-space:pre-wrap;line-height:1.65;max-height:500px;overflow-y:auto;border-top:1px solid rgba(139,124,246,.1);padding-top:12px;margin:0 2px;font-family:'JetBrains Mono','SF Mono',monospace}
.think-tx::-webkit-scrollbar{width:3px}.think-tx::-webkit-scrollbar-thumb{background:rgba(139,124,246,.18);border-radius:2px}

/* ‚ïê‚ïê‚ïê MARKDOWN ‚ïê‚ïê‚ïê */
.md h1{font-size:1.4em;font-weight:700;margin:16px 0 8px;color:var(--tx);border-bottom:1px solid var(--bdr);padding-bottom:6px}
.md h2{font-size:1.25em;font-weight:700;margin:14px 0 6px;color:var(--tx)}
.md h3{font-size:1.1em;font-weight:600;margin:12px 0 4px;color:var(--tx)}
.md h4,.md h5,.md h6{font-size:1em;font-weight:600;margin:10px 0 4px;color:var(--tx2)}
.md p{margin:6px 0;line-height:1.72}
.md strong{font-weight:600;color:var(--tx)}
.md em{font-style:italic}
.md del{text-decoration:line-through;opacity:.7}
.md a{color:var(--ac2);text-decoration:underline;text-underline-offset:2px}
.md a:hover{color:var(--ac)}
.md hr{border:none;border-top:1px solid var(--bdr2);margin:14px 0}
.md blockquote{border-left:3px solid var(--ac);padding:4px 12px;margin:8px 0;color:var(--tx2);background:rgba(139,124,246,.03);border-radius:0 6px 6px 0}
.md ul,.md ol{margin:6px 0;padding-left:22px}
.md li{margin:3px 0;line-height:1.65}
.md li::marker{color:var(--tx3)}
.md .il{background:rgba(139,124,246,.1);padding:1.5px 5px;border-radius:4px;font-family:'JetBrains Mono',monospace;font-size:.88em;color:var(--ac2)}
.md .cb{position:relative;margin:10px 0;border-radius:8px;overflow:hidden;background:#0d0d12;border:1px solid var(--bdr)}
.md .cb-hd{display:flex;justify-content:space-between;align-items:center;padding:6px 12px;background:rgba(255,255,255,.03);border-bottom:1px solid var(--bdr);font-size:10px;color:var(--tx3)}
.md .cp-btn{background:var(--sf3);border:1px solid var(--bdr);color:var(--tx3);padding:3px 10px;border-radius:5px;font:500 10px/1 'Inter',sans-serif;cursor:pointer;transition:.2s;display:inline-flex;align-items:center;gap:4px}
.md .cp-btn:hover{color:var(--tx);background:var(--sb-hov)}
.md .cp-btn.copied{color:var(--grn);border-color:rgba(74,222,128,.25)}
.md .cb code{display:block;padding:12px;overflow-x:auto;font-family:'JetBrains Mono',monospace;font-size:12px;line-height:1.6;color:var(--tx2);white-space:pre;tab-size:2}
.md .cb code::-webkit-scrollbar{height:4px}.md .cb code::-webkit-scrollbar-thumb{background:rgba(255,255,255,.08);border-radius:2px}
.md .tbl-w{overflow-x:auto;margin:8px 0;border-radius:8px;border:1px solid var(--bdr)}
.md table{border-collapse:collapse;width:100%;font-size:12.5px}
.md th,.md td{border:1px solid var(--bdr);padding:6px 10px;text-align:left}
.md th{background:var(--sf2);font-weight:600;color:var(--tx)}
.md td{color:var(--tx2)}

/* ‚ïê‚ïê‚ïê TOKEN FOOTER ‚ïê‚ïê‚ïê */
.msg-ft{display:flex;align-items:center;gap:5px;flex-wrap:wrap;margin-top:10px;padding-top:10px;border-top:1px solid var(--bdr)}
.tk{font-size:9.5px;font-weight:500;color:var(--tx3);background:rgba(255,255,255,.03);border:1px solid var(--bdr);padding:2px 7px;border-radius:5px;display:inline-flex;align-items:center;gap:3px}
.tk .n{color:var(--tx2)}

/* ‚ïê‚ïê‚ïê CONTINUATION ‚ïê‚ïê‚ïê */
.cont-status{padding:6px 0}
.cont-ind{display:flex;align-items:center;gap:6px;font-size:11px;color:var(--ac);font-weight:500;padding:4px 0}
.cont-ind .pulse{width:8px;height:8px;border-radius:50%;background:var(--ac);animation:glow 1.5s ease-in-out infinite;flex-shrink:0}
.cont-badge{font-size:9.5px;font-weight:500;color:var(--ac);background:var(--ac-g);border:1px solid rgba(139,124,246,.2);padding:2px 7px;border-radius:5px;display:inline-flex;align-items:center;gap:3px}
.cont-btn{background:var(--ac-g);border:1px solid rgba(139,124,246,.25);color:var(--ac);padding:4px 12px;border-radius:6px;font:600 10px/1 'Inter',sans-serif;cursor:pointer;transition:.2s;display:inline-flex;align-items:center;gap:4px;white-space:nowrap}
.cont-btn:hover{background:rgba(139,124,246,.2);color:var(--ac2)}
.cont-btn:disabled{opacity:.4;cursor:not-allowed}

/* ‚ïê‚ïê‚ïê CURSOR ‚ïê‚ïê‚ïê */
.cursor{display:inline-block;width:6px;height:15px;background:var(--ac);animation:blink .8s step-end infinite;vertical-align:text-bottom;margin-left:2px;border-radius:1px}
@keyframes blink{50%{opacity:0}}
.think-indicator{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--ac);font-weight:500;padding:4px 0}
.think-indicator .pulse{width:8px;height:8px;border-radius:50%;background:var(--ac);animation:glow 1.5s ease-in-out infinite}
@keyframes glow{0%,100%{opacity:.3;box-shadow:0 0 4px var(--ac-g)}50%{opacity:1;box-shadow:0 0 12px var(--ac-g)}}

/* ‚ïê‚ïê‚ïê NAV RAIL ‚ïê‚ïê‚ïê */
.nav-r{width:var(--nw);min-width:var(--nw);background:var(--sf);border-left:1px solid var(--bdr);display:flex;flex-direction:column;align-items:center;position:relative;overflow:hidden}
.nr-inner{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;padding:12px 0;overflow-y:auto;position:relative;z-index:1;width:100%}
.nr-inner::-webkit-scrollbar{display:none}
.nr-trk{position:absolute;width:2px;top:12px;bottom:12px;left:50%;transform:translateX(-50%);background:var(--bdr);border-radius:1px;z-index:0}
.nr-dot{width:10px;height:10px;border-radius:50%;cursor:pointer;transition:all .2s;flex-shrink:0;position:relative;border:2px solid transparent}
.nr-dot.u{background:var(--ac);opacity:.35}
.nr-dot.a{background:#f59e0b;opacity:.35}
.nr-dot.act{opacity:1;transform:scale(1.5);box-shadow:0 0 8px rgba(139,124,246,.3)}
.nr-dot:hover{opacity:.8;transform:scale(1.3)}
.nr-empty{writing-mode:vertical-rl;font-size:9px;color:var(--tx3);letter-spacing:1px;text-transform:uppercase;opacity:.5;user-select:none}

/* ‚ïê‚ïê‚ïê NAV TOOLTIP (fixed position, escapes overflow) ‚ïê‚ïê‚ïê */
.nav-tooltip{position:fixed;background:var(--sf2);border:1px solid var(--bdr2);padding:10px 14px;border-radius:10px;font-size:11px;color:var(--tx2);max-width:300px;max-height:160px;overflow:hidden;pointer-events:none;opacity:0;transition:opacity .15s;z-index:200;line-height:1.55;box-shadow:0 8px 30px rgba(0,0,0,.5);word-break:break-word}
.nav-tooltip.vis{opacity:1}
.nav-tooltip .nt-role{font-weight:600;font-size:9.5px;text-transform:uppercase;letter-spacing:.5px;margin-bottom:5px}
.nav-tooltip .nt-text{color:var(--tx2);white-space:pre-wrap;display:-webkit-box;-webkit-line-clamp:6;-webkit-box-orient:vertical;overflow:hidden}

/* ‚ïê‚ïê‚ïê INPUT ‚ïê‚ïê‚ïê */
#inpArea{padding:12px 18px;border-top:1px solid var(--bdr);background:var(--sf)}
.inp-r{display:flex;gap:8px;align-items:flex-end;max-width:780px;margin:0 auto}
#uInp{flex:1;resize:none;background:var(--sf2);color:var(--tx);border:1px solid var(--bdr2);border-radius:14px;padding:12px 16px;font:13.5px/1.5 'Inter',sans-serif;max-height:150px;overflow-y:auto;outline:0;transition:.25s}
#uInp:focus{border-color:var(--ac);box-shadow:0 0 0 3px var(--ac-g)}
#uInp::placeholder{color:var(--tx3)}
.btn-g{display:flex;gap:6px}
.btn{border:none;border-radius:12px;padding:12px 16px;font:600 12px/1 'Inter',sans-serif;cursor:pointer;transition:.2s;white-space:nowrap}
.btn-s{background:linear-gradient(135deg,var(--ac),var(--ac2));color:#fff;box-shadow:0 2px 12px var(--ac-g)}
.btn-s:hover{box-shadow:0 4px 20px rgba(139,124,246,.25);transform:translateY(-1px)}
.btn-s:active{transform:translateY(0)}
.btn-s:disabled{opacity:.3;cursor:not-allowed;transform:none;box-shadow:none}
.btn-c{background:var(--sf3);color:var(--tx2);border:1px solid var(--bdr)}
.btn-c:hover{background:#28283a;color:var(--tx)}

/* ‚ïê‚ïê‚ïê RESPONSIVE ‚ïê‚ïê‚ïê */
@media(max-width:768px){
  .sidebar{position:fixed;left:0;top:0;bottom:0;transform:translateX(-100%);box-shadow:4px 0 24px rgba(0,0,0,.4)}
  .sidebar.open{transform:translateX(0)}.sb-ov.act{display:block}
  .hamburger{display:flex}
  .hdr-r{display:none}
  .sel-w{max-width:100%}
  .nav-r{display:none}
  #chatArea{padding:14px 8px}
  .msg{padding:14px 16px;font-size:13px}
  #inpArea{padding:10px}
  #uInp{padding:10px 14px;font-size:13px}
  .btn{padding:10px 12px;font-size:11.5px}
  .ac-label-full{display:none}
}
@media(min-width:769px){
  .ac-label-short{display:none}
}
</style>
</head>
<body>
<div class="app">
  <aside class="sidebar" id="sidebar">
    <div class="sb-hd">
      <div class="sb-br"><div class="sb-logo">‚ú¶</div><span class="sb-ti">Claude Chat</span></div>
      <button class="btn-nw" onclick="newChat()"><span>Ôºã</span> New Chat</button>
    </div>
    <div class="sb-ls" id="sbList"></div>
  </aside>
  <div class="sb-ov" id="sbOv" onclick="closeSB()"></div>
  <div class="main">
    <div class="hdr">
      <button class="hamburger" onclick="toggleSB()">‚ò∞</button>
      <div class="sel-w"><select id="modSel"></select></div>
      <label class="ac-toggle" title="Auto-continue when response is cut off by token limits">
        <input type="checkbox" id="autoCont" checked>
        <span class="ac-label-full">Auto-continue</span>
        <span class="ac-label-short">‚Üª Auto</span>
      </label>
      <div class="hdr-r">
        <div class="price" id="prDisp"></div>
        <div class="cost-b" id="costB" style="display:none">$0.0000</div>
      </div>
    </div>
    <div class="chat-w">
      <div id="chatArea"></div>
      <div class="nav-r" id="navR">
        <div class="nr-trk"></div>
        <div class="nr-inner" id="nrDots"></div>
      </div>
      <div class="nav-tooltip" id="navTip"></div>
    </div>
    <div id="inpArea">
      <div class="inp-r">
        <textarea id="uInp" rows="1" placeholder="Message Claude‚Ä¶"></textarea>
        <div class="btn-g">
          <button class="btn btn-c" onclick="clearCur()">Clear</button>
          <button class="btn btn-s" id="sendBtn" onclick="send()">Send ‚Üë</button>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
/* ‚ïê‚ïê‚ïê MODELS ‚ïê‚ïê‚ïê */
const MODELS=[
{id:"claude-opus-4-5-20251101-thinking",label:"Opus 4.5 (thinking)",pi:2.5,po:12.5,think:true,tier:"opus"},
{id:"claude-opus-4-5-20251101",label:"Opus 4.5",pi:2.5,po:12.5,tier:"opus"},
{id:"claude-opus-4-6",label:"Opus 4.6",pi:2.5,po:12.5,tier:"opus"},
{id:"claude-opus-4-1-20250805-thinking",label:"Opus 4.1 (thinking)",pi:7.5,po:37.5,think:true,tier:"opus"},
{id:"claude-opus-4-1-20250805",label:"Opus 4.1",pi:7.5,po:37.5,tier:"opus"},
{id:"claude-opus-4-20250514-thinking",label:"Opus 4 (thinking)",pi:7.5,po:37.5,think:true,tier:"opus"},
{id:"claude-opus-4-20250514",label:"Opus 4",pi:7.5,po:37.5,tier:"opus"},
{id:"claude-sonnet-4-5-20250929-thinking",label:"Sonnet 4.5 (thinking)",pi:1.5,po:7.5,think:true,tier:"sonnet"},
{id:"claude-sonnet-4-5-20250929",label:"Sonnet 4.5",pi:1.5,po:7.5,tier:"sonnet"},
{id:"claude-sonnet-4-20250514-thinking",label:"Sonnet 4 (thinking)",pi:1.5,po:7.5,think:true,tier:"sonnet"},
{id:"claude-sonnet-4-20250514",label:"Sonnet 4",pi:1.5,po:7.5,tier:"sonnet"},
{id:"claude-3-7-sonnet-20250219-thinking",label:"3.7 Sonnet (thinking)",pi:1.5,po:7.5,think:true,tier:"sonnet"},
{id:"claude-3-7-sonnet-20250219",label:"3.7 Sonnet",pi:1.5,po:7.5,tier:"sonnet"},
{id:"claude-3-5-sonnet-20241022",label:"3.5 Sonnet v2",pi:4.5,po:22.5,tier:"sonnet"},
{id:"claude-3-5-sonnet-20240620",label:"3.5 Sonnet v1",pi:4.5,po:22.5,tier:"sonnet"},
{id:"claude-haiku-4-5-20251001-thinking",label:"Haiku 4.5 (thinking)",pi:.5,po:2.5,think:true,tier:"haiku"},
{id:"claude-haiku-4-5-20251001",label:"Haiku 4.5",pi:.5,po:2.5,tier:"haiku"},
{id:"claude-3-5-haiku-20241022",label:"3.5 Haiku",pi:.4,po:2,tier:"haiku"},
{id:"ggg-5-codex",label:"GGG-5 Codex",pi:1.875,po:15,tier:"other"},
{id:"ggg-5-codex-high",label:"GGG-5 Codex High",pi:.939,po:7.512,tier:"other"},
];
const TIERS={opus:"Opus",sonnet:"Sonnet",haiku:"Haiku",other:"Other"};
const MAX_CONT=30;

/* ‚ïê‚ïê‚ïê ROBUSTNESS CONSTANTS ‚ïê‚ïê‚ïê */
const FETCH_TIMEOUT_MS=180000;
const MAX_RETRIES=2;
const RETRY_BASE_MS=3000;
const CONT_DELAY_MS=60000;            /* 1-min cooldown before auto-continue */
const MAX_HISTORY_CHARS=800000;
const STREAM_STALL_MS=45000;
const STALL_WARN_MS=30000;
const OVERALL_TIMEOUT_MS=10000000;     /* cont. working total time */

/* ‚ïê‚ïê‚ïê DOM ‚ïê‚ïê‚ïê */
const $=s=>document.getElementById(s);
const chatArea=$('chatArea'),uInp=$('uInp'),sendBtn=$('sendBtn'),
      modSel=$('modSel'),prDisp=$('prDisp'),costB=$('costB'),
      sbList=$('sbList'),sidebar=$('sidebar'),sbOv=$('sbOv'),
      nrDots=$('nrDots');

/* ‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê */
let chats=[],curId=null,sending=false;
const rawContentMap=new WeakMap();
let lastContState=null;
function gc(id){return chats.find(c=>c.id===(id||curId))}
function cc(){return gc(curId)}

/* ‚ïê‚ïê‚ïê UTILITY: sleep ‚ïê‚ïê‚ïê */
function sleep(ms){return new Promise(r=>setTimeout(r,ms))}

/* ‚ïê‚ïê‚ïê UTILITY: read from stream reader with stall timeout ‚ïê‚ïê‚ïê */
function readWithStallTimeout(reader,ms){
  return new Promise((resolve,reject)=>{
    const timer=setTimeout(()=>{
      reader.cancel().catch(()=>{});
      reject(new Error('Stream stalled (no data for '+(ms/1000)+'s)'));
    },ms);
    reader.read().then(
      result=>{clearTimeout(timer);resolve(result)},
      err=>{clearTimeout(timer);reject(err)}
    );
  });
}

/* ‚ïê‚ïê‚ïê STORAGE ‚ïê‚ïê‚ïê */
function save(){try{localStorage.setItem('ccs',JSON.stringify({chats,curId}))}catch(e){}}
function load(){try{const d=localStorage.getItem('ccs');if(d){const s=JSON.parse(d);chats=s.chats||[];curId=s.curId||null}}catch(e){}}

/* ‚ïê‚ïê‚ïê MODEL SEL ‚ïê‚ïê‚ïê */
(function(){
  const t={};MODELS.forEach(m=>{if(!t[m.tier])t[m.tier]=[];t[m.tier].push(m)});
  for(const[k,ms]of Object.entries(t)){
    const g=document.createElement('optgroup');g.label=TIERS[k]||k;
    ms.forEach(m=>{const o=document.createElement('option');o.value=m.id;o.textContent=`${m.label}  ¬∑  $${m.pi}/$${m.po}`;g.appendChild(o)});
    modSel.appendChild(g);
  }
})();
modSel.value="claude-opus-4-6";
modSel.addEventListener('change',()=>{
  updPrice();
  const c=cc();
  if(c){c.modelId=modSel.value;renderSB();save()}
});
function updPrice(){
  const m=MODELS.find(x=>x.id===modSel.value);
  if(!m){prDisp.innerHTML='';return}
  prDisp.innerHTML=`<span class="pi">‚Üë $${m.pi}/M</span><span class="sp">¬∑</span><span class="po">‚Üì $${m.po}/M</span>`;
}
updPrice();
function updCost(){
  const c=cc();if(!c)return;
  const m=MODELS.find(x=>x.id===modSel.value);if(!m)return;
  costB.textContent='$'+((c.tokIn/1e6*m.pi)+(c.tokOut/1e6*m.po)).toFixed(4);
  costB.style.display='inline-block';
}

/* ‚ïê‚ïê‚ïê HTML ESCAPE ‚ïê‚ïê‚ïê */
function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML}
function fmtT(ts){return new Date(ts).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}

/* ‚ïê‚ïê‚ïê HEURISTIC: detect truncated response ‚ïê‚ïê‚ïê */
function looksIncomplete(text){
  if(!text||text.length<200)return false;
  const fences=(text.match(/```/g)||[]).length;
  if(fences%2!==0)return true;
  const t=text.trimEnd();
  if(t.length>800){
    const last=t.slice(-1);
    if(/[a-zA-Z,(\[{=]/.test(last))return true;
  }
  return false;
}

/* ‚ïê‚ïê‚ïê HISTORY TRIMMING ‚ïê‚ïê‚ïê */
function trimHistory(history){
  let safety=0;
  while(history.length>2&&JSON.stringify(history).length>MAX_HISTORY_CHARS&&safety<200){
    history.splice(0,2);
    safety++;
  }
  if(history.length>0&&JSON.stringify(history).length>MAX_HISTORY_CHARS){
    for(let i=0;i<history.length;i++){
      if(typeof history[i].content==='string'&&history[i].content.length>50000){
        history[i].content=history[i].content.slice(0,50000)+'\n\n[‚Ä¶truncated due to context length‚Ä¶]';
      }
    }
  }
  return history;
}

/* ‚ïê‚ïê‚ïê FETCH WITH TIMEOUT + RETRY ‚ïê‚ïê‚ïê */
async function fetchWithRetry(url,opts,retries){
  if(retries===undefined)retries=MAX_RETRIES;
  let lastErr;
  for(let attempt=0;attempt<=retries;attempt++){
    const controller=new AbortController();
    const tid=setTimeout(()=>controller.abort(),FETCH_TIMEOUT_MS);
    try{
      const res=await fetch(url,{...opts,signal:controller.signal});
      clearTimeout(tid);
      if((res.status===429||res.status===529||res.status>=500)&&attempt<retries){
        const delay=RETRY_BASE_MS*Math.pow(2,attempt);
        console.warn('[fetchWithRetry] HTTP',res.status,'‚Äî retrying in',delay+'ms (attempt',attempt+1+'/'+retries+')');
        await sleep(delay);
        continue;
      }
      return res;
    }catch(e){
      clearTimeout(tid);
      lastErr=e;
      if(e.name==='AbortError'){
        lastErr=new Error('Request timed out after '+(FETCH_TIMEOUT_MS/1000)+'s');
      }
      if(attempt<retries){
        const delay=RETRY_BASE_MS*Math.pow(2,attempt);
        console.warn('[fetchWithRetry] Network error, retrying in',delay+'ms:',e.message);
        await sleep(delay);
        continue;
      }
    }
  }
  throw lastErr||new Error('Fetch failed after retries');
}

/* ‚ïê‚ïê‚ïê MARKDOWN ‚ïê‚ïê‚ïê */
function renderMd(src){
  if(!src)return'';
  const cbs=[],ics=[];
  src=src.replace(/```(\w*)\n?([\s\S]*?)```/g,(_,l,c)=>{cbs.push({l:l||'',c});return'\x00CB'+(cbs.length-1)+'\x00'});
  src=src.replace(/```(\w*)\n([\s\S]*)$/,(_,l,c)=>{cbs.push({l:l||'',c});return'\x00CB'+(cbs.length-1)+'\x00'});
  src=src.replace(/`([^`\n]+)`/g,(_,c)=>{ics.push(c);return'\x00IC'+(ics.length-1)+'\x00'});
  function il(t){
    t=esc(t);
    t=t.replace(/\x00IC(\d+)\x00/g,(_,n)=>'<code class="il">'+esc(ics[+n])+'</code>');
    t=t.replace(/\*\*\*(.+?)\*\*\*/g,'<strong><em>$1</em></strong>');
    t=t.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>');
    t=t.replace(/(?<!\w)\*([^*]+?)\*(?!\w)/g,'<em>$1</em>');
    t=t.replace(/~~(.+?)~~/g,'<del>$1</del>');
    t=t.replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank" rel="noopener">$1</a>');
    return t;
  }
  function tr(s){const c=s.split('|').map(x=>x.trim());if(c[0]==='')c.shift();if(c[c.length-1]==='')c.pop();return c}
  const L=src.split('\n');let h='',i=0,prevBlank=true;
  while(i<L.length){
    const ln=L[i];
    if(prevBlank&&/^(\s{4,}|\t)/.test(ln)&&!/^\s*[-*+]\s+/.test(ln)&&!/^\s*\d+[.)]\s+/.test(ln)){
      let code='';
      while(i<L.length&&(/^(\s{4,}|\t)/.test(L[i])||L[i].trim()==='')){code+=L[i].replace(/^(\s{4}|\t)/,'')+'\n';i++}
      code=code.replace(/\n+$/,'\n');
      h+='<div class="cb"><div class="cb-hd"><span>code</span><button class="cp-btn" onclick="cpCode(this)">üìã Copy Code</button></div><code>'+esc(code)+'</code></div>';
      prevBlank=false;continue;
    }
    const cbm=ln.trim().match(/^\x00CB(\d+)\x00$/);
    if(cbm){const b=cbs[+cbm[1]];h+='<div class="cb"><div class="cb-hd"><span>'+esc(b.l||'code')+'</span><button class="cp-btn" onclick="cpCode(this)">üìã Copy Code</button></div><code>'+esc(b.c)+'</code></div>';prevBlank=false;i++;continue}
    const hm=ln.match(/^(#{1,6})\s+(.+)/);
    if(hm){h+='<h'+hm[1].length+'>'+il(hm[2])+'</h'+hm[1].length+'>';prevBlank=false;i++;continue}
    if(/^(-{3,}|\*{3,}|_{3,})\s*$/.test(ln.trim())){h+='<hr>';prevBlank=false;i++;continue}
    if(/^>\s?/.test(ln)){let bq='';while(i<L.length&&/^>\s?/.test(L[i])){bq+=(bq?'<br>':'')+il(L[i].replace(/^>\s?/,''));i++}h+='<blockquote>'+bq+'</blockquote>';prevBlank=false;continue}
    if(/^\s*[-*+]\s+/.test(ln)){h+='<ul>';while(i<L.length&&/^\s*[-*+]\s+/.test(L[i])){h+='<li>'+il(L[i].replace(/^\s*[-*+]\s+/,''))+'</li>';i++}h+='</ul>';prevBlank=false;continue}
    if(/^\s*\d+[.)]\s+/.test(ln)){h+='<ol>';while(i<L.length&&/^\s*\d+[.)]\s+/.test(L[i])){h+='<li>'+il(L[i].replace(/^\s*\d+[.)]\s+/,''))+'</li>';i++}h+='</ol>';prevBlank=false;continue}
    if(ln.includes('|')&&i+1<L.length&&/^\|?\s*:?-+:?\s*(\|\s*:?-+:?\s*)*\|?\s*$/.test(L[i+1])){
      const hc=tr(ln);i+=2;h+='<div class="tbl-w"><table><thead><tr>';hc.forEach(c=>h+='<th>'+il(c)+'</th>');h+='</tr></thead><tbody>';
      while(i<L.length&&L[i].includes('|')&&L[i].trim()){h+='<tr>';tr(L[i]).forEach(c=>h+='<td>'+il(c)+'</td>');h+='</tr>';i++}
      h+='</tbody></table></div>';prevBlank=false;continue}
    if(!ln.trim()){prevBlank=true;i++;continue}
    let p='';
    while(i<L.length&&L[i].trim()&&!/^#{1,6}\s/.test(L[i])&&!/^\s*[-*+]\s+/.test(L[i])&&!/^\s*\d+[.)]\s+/.test(L[i])&&!/^>\s?/.test(L[i])&&!/^(-{3,}|\*{3,}|_{3,})\s*$/.test(L[i].trim())&&!/^\x00CB/.test(L[i].trim())&&!(L[i].includes('|')&&i+1<L.length&&/^\|?\s*:?-+:?\s*/.test(L[i+1]))){
      p+=(p?'<br>':'')+il(L[i]);i++}
    if(p)h+='<p>'+p+'</p>';
    prevBlank=false;
  }
  return h;
}
function cpCode(btn){
  const code=btn.closest('.cb').querySelector('code').textContent;
  navigator.clipboard.writeText(code).then(()=>{
    btn.textContent='‚úì Copied!';btn.classList.add('copied');
    setTimeout(()=>{btn.textContent='üìã Copy Code';btn.classList.remove('copied')},2000);
  });
}

/* ‚ïê‚ïê‚ïê COPY MESSAGE (works for both user & assistant) ‚ïê‚ïê‚ïê */
function cpResp(btn){
  const row=btn.closest('.msg-row');
  const raw=rawContentMap.get(row);
  if(!raw&&raw!==''){
    const body=row.querySelector('.msg-body');
    if(body)navigator.clipboard.writeText(body.textContent);
  } else {
    navigator.clipboard.writeText(raw);
  }
  btn.innerHTML='‚úì Copied';btn.classList.add('copied');
  setTimeout(()=>{btn.innerHTML='üìã Copy';btn.classList.remove('copied')},2000);
}

/* ‚ïê‚ïê‚ïê SIDEBAR ‚ïê‚ïê‚ïê */
function renderSB(){
  sbList.innerHTML='';
  const now=new Date(),yd=new Date(now);yd.setDate(yd.getDate()-1);
  const g={};
  chats.forEach(c=>{const d=new Date(c.created);let l;if(d.toDateString()===now.toDateString())l='Today';else if(d.toDateString()===yd.toDateString())l='Yesterday';else l='Older';if(!g[l])g[l]=[];g[l].push(c)});
  for(const[label,list]of Object.entries(g)){
    const h=document.createElement('div');h.className='sb-dt';h.textContent=label;sbList.appendChild(h);
    list.forEach(c=>{
      const it=document.createElement('div');it.className='sb-it'+(c.id===curId?' act':'');
      it.onclick=e=>{if(!e.target.closest('.sb-dl')){switchChat(c.id);closeSB()}};
      const m=MODELS.find(x=>x.id===c.modelId),cnt=c.msgs.filter(x=>x.role==='user').length;
      it.innerHTML=`<div class="sb-ic">üí¨</div><div class="sb-bd"><div class="sb-tt">${esc(c.title)}</div><div class="sb-mt">${m?m.label:'‚Äî'} ¬∑ ${cnt} msg${cnt!==1?'s':''}</div></div><button class="sb-dl" title="Delete">√ó</button>`;
      it.querySelector('.sb-dl').onclick=e=>{e.stopPropagation();delChat(c.id)};
      sbList.appendChild(it);
    });
  }
}

/* ‚ïê‚ïê‚ïê NAV RAIL ‚ïê‚ïê‚ïê */
function showNavTip(e){
  const dot=e.currentTarget;
  const tip=$('navTip');
  const rect=dot.getBoundingClientRect();
  const role=dot.dataset.role;
  const pv=dot.dataset.pv||'';
  const roleLabel=role==='user'?'You':'Claude';
  const roleColor=role==='user'?'#a78bfa':'#f59e0b';
  tip.innerHTML='<div class="nt-role" style="color:'+roleColor+'">'+roleLabel+'</div><div class="nt-text">'+esc(pv)+'</div>';
  tip.style.right=(window.innerWidth-rect.left+10)+'px';
  tip.style.left='auto';
  tip.style.top=(rect.top+rect.height/2)+'px';
  tip.style.transform='translateY(-50%)';
  tip.classList.add('vis');
  /* Clamp to viewport after render */
  requestAnimationFrame(()=>{
    const tr=tip.getBoundingClientRect();
    if(tr.top<8){tip.style.top='8px';tip.style.transform='none'}
    else if(tr.bottom>window.innerHeight-8){tip.style.top=(window.innerHeight-8-tr.height)+'px';tip.style.transform='none'}
  });
}
function hideNavTip(){$('navTip').classList.remove('vis')}

function updNav(){
  nrDots.innerHTML='';
  const c=cc();
  if(!c||c.msgs.length===0){nrDots.innerHTML='<span class="nr-empty">no messages</span>';return}
  c.msgs.forEach((m,idx)=>{
    const dot=document.createElement('div');
    dot.className='nr-dot '+(m.role==='user'?'u':'a');
    dot.dataset.idx=idx;
    dot.dataset.role=m.role;
    const pvLen=200;
    dot.dataset.pv=(m.content||'').length>pvLen?(m.content||'').slice(0,pvLen)+'‚Ä¶':(m.content||'(empty)');
    dot.addEventListener('mouseenter',showNavTip);
    dot.addEventListener('mouseleave',hideNavTip);
    dot.onclick=()=>{const rows=chatArea.querySelectorAll('.msg-row');if(rows[idx])rows[idx].scrollIntoView({behavior:'smooth',block:'start'})};
    nrDots.appendChild(dot);
  });
  syncNavScroll();
}
function syncNavScroll(){
  const rows=chatArea.querySelectorAll('.msg-row');
  if(!rows.length)return;
  const center=chatArea.scrollTop+chatArea.clientHeight/2;
  let best=0,bestD=Infinity;
  rows.forEach((r,i)=>{const d=Math.abs(r.offsetTop+r.offsetHeight/2-center);if(d<bestD){bestD=d;best=i}});
  const dots=nrDots.querySelectorAll('.nr-dot');
  dots.forEach(d=>d.classList.remove('act'));
  if(dots[best])dots[best].classList.add('act');
}
let scrollRaf=null;
chatArea.addEventListener('scroll',()=>{if(scrollRaf)return;scrollRaf=requestAnimationFrame(()=>{syncNavScroll();scrollRaf=null})});

/* ‚ïê‚ïê‚ïê CHAT MGMT ‚ïê‚ïê‚ïê */
function newChat(){
  const c={id:Date.now().toString(),title:'New Chat',modelId:modSel.value,msgs:[],history:[],tokIn:0,tokOut:0,created:Date.now()};
  chats.unshift(c);curId=c.id;lastContState=null;renderSB();renderMsgs();updNav();save();uInp.focus();
}
function switchChat(id){
  if(id===curId)return;curId=id;lastContState=null;const c=cc();if(c)modSel.value=c.modelId;
  updPrice();renderSB();renderMsgs();updNav();save();
}
function delChat(id){
  chats=chats.filter(c=>c.id!==id);
  if(curId===id){lastContState=null;if(chats.length>0){curId=chats[0].id;const c=cc();if(c)modSel.value=c.modelId;updPrice()}else newChat()}
  renderSB();renderMsgs();updNav();save();
}
function clearCur(){
  const c=cc();if(!c)return;c.msgs=[];c.history=[];c.tokIn=0;c.tokOut=0;c.title='New Chat';
  lastContState=null;costB.style.display='none';renderSB();renderMsgs();updNav();save();
}

/* ‚ïê‚ïê‚ïê MSG RENDERING ‚ïê‚ïê‚ïê */
function renderMsgs(){
  chatArea.innerHTML='';const c=cc();
  if(!c||c.msgs.length===0){chatArea.innerHTML='<div class="empty"><div class="empty-ic">‚ú¶</div><div class="empty-h">Start a conversation</div><div class="empty-p">Choose a model above and type your message below to begin chatting.</div></div>';costB.style.display='none';return}
  c.msgs.forEach((m,i)=>appendEl(m,i,false));scrollEnd();updCost();
}

function appendEl(data,idx,anim=true){
  const row=document.createElement('div');row.className='msg-row';row.dataset.msgIdx=idx;
  if(!anim)row.style.animation='none';
  const msg=document.createElement('div');msg.className='msg '+data.role;

  const hdr=document.createElement('div');hdr.className='msg-hdr';
  const av=document.createElement('div');av.className='msg-av';av.textContent=data.role==='user'?'‚ü°':'‚ú¶';
  const nm=document.createElement('span');nm.className='msg-nm';nm.textContent=data.role==='user'?'You':'Claude';
  hdr.appendChild(av);hdr.appendChild(nm);
  if(data.modelLabel){const ml=document.createElement('span');ml.className='msg-ml';ml.textContent='¬∑ '+data.modelLabel;hdr.appendChild(ml)}
  if(data.ts){const t=document.createElement('span');t.className='msg-tm';t.textContent=fmtT(data.ts);hdr.appendChild(t)}
  /* Copy button for BOTH user and assistant (non-error) messages */
  if(!data.isError){
    const cpBtn=document.createElement('button');cpBtn.className='cp-resp-btn';cpBtn.innerHTML='üìã Copy';cpBtn.onclick=function(){cpResp(this)};
    hdr.appendChild(cpBtn);
  }
  msg.appendChild(hdr);

  if(data.thinking){
    const tk=document.createElement('div');tk.className='think open';
    const wc=data.thinking.trim().split(/\s+/).length;
    const thd=document.createElement('div');thd.className='think-hd';
    thd.innerHTML='<div class="think-ic">üí≠</div><span class="think-lb">Thinking Process</span><span class="think-mt">'+wc.toLocaleString()+' words</span><span class="think-ch">‚ñ∂</span>';
    thd.onclick=()=>tk.classList.toggle('open');
    const tbd=document.createElement('div');tbd.className='think-bd';
    const ttx=document.createElement('div');ttx.className='think-tx';ttx.textContent=data.thinking;
    tbd.appendChild(ttx);tk.appendChild(thd);tk.appendChild(tbd);msg.appendChild(tk);
  }

  const body=document.createElement('div');body.className='msg-body';
  if(data.isError){body.classList.add('err-text');body.textContent=data.content}
  else if(data.role==='assistant'){body.classList.add('md');body.innerHTML=renderMd(data.content)}
  else{body.textContent=data.content}
  msg.appendChild(body);

  if(data.usage||data.continuations){
    const ft=document.createElement('div');ft.className='msg-ft';
    const inp=data.usage?.input_tokens||0,out=data.usage?.output_tokens||0;
    ft.innerHTML='<span class="tk">‚Üë in <span class="n">'+inp.toLocaleString()+'</span></span><span class="tk">‚Üì out <span class="n">'+out.toLocaleString()+'</span></span>';
    if(data.usage?.cache_read)ft.innerHTML+='<span class="tk">üì¶ cache <span class="n">'+data.usage.cache_read.toLocaleString()+'</span></span>';
    if(data.continuations>0)ft.innerHTML+='<span class="cont-badge">üîÑ '+data.continuations+' continuation'+(data.continuations>1?'s':'')+'</span>';
    msg.appendChild(ft);
  }
  row.appendChild(msg);chatArea.appendChild(row);
  /* Store raw content for copy ‚Äî both roles */
  if(!data.isError){rawContentMap.set(row,data.content||'')}
}

/* ‚ïê‚ïê‚ïê STREAM HELPERS ‚ïê‚ïê‚ïê */
function mkStreamEl(model){
  const row=document.createElement('div');row.className='msg-row';
  const idx=chatArea.querySelectorAll('.msg-row').length;
  row.dataset.msgIdx=idx;
  const msg=document.createElement('div');msg.className='msg assistant';

  const hdr=document.createElement('div');hdr.className='msg-hdr';
  hdr.innerHTML='<div class="msg-av">‚ú¶</div><span class="msg-nm">Claude</span>'+(model?'<span class="msg-ml">¬∑ '+esc(model.label)+'</span>':'')+'<span class="msg-tm">'+fmtT(Date.now())+'</span>';
  const cpBtn=document.createElement('button');cpBtn.className='cp-resp-btn';cpBtn.innerHTML='üìã Copy';cpBtn.style.display='none';cpBtn.onclick=function(){cpResp(this)};
  hdr.appendChild(cpBtn);
  msg.appendChild(hdr);

  const tk=document.createElement('div');tk.className='think open';tk.style.display='none';
  tk.innerHTML='<div class="think-hd"><div class="think-ic">üí≠</div><span class="think-lb">Thinking‚Ä¶</span><span class="think-mt"></span><span class="think-ch">‚ñ∂</span></div><div class="think-bd"><div class="think-tx"></div></div>';
  tk.querySelector('.think-hd').onclick=()=>tk.classList.toggle('open');
  msg.appendChild(tk);

  const body=document.createElement('div');body.className='msg-body md';
  const cur=document.createElement('span');cur.className='cursor';body.appendChild(cur);
  msg.appendChild(body);

  const contStatus=document.createElement('div');contStatus.className='cont-status';contStatus.style.display='none';
  msg.appendChild(contStatus);

  const ft=document.createElement('div');ft.className='msg-ft';ft.style.display='none';
  msg.appendChild(ft);
  row.appendChild(msg);

  return{row,msg,tk,body,cur,ft,cpBtn,contStatus,
         ttx:tk.querySelector('.think-tx'),tmt:tk.querySelector('.think-mt'),tlb:tk.querySelector('.think-lb')};
}

let mdTimer=null;
function flushMd(el,txt){
  if(mdTimer){cancelAnimationFrame(mdTimer);mdTimer=null}
  el.body.innerHTML=renderMd(txt);el.body.appendChild(el.cur);
  if(nearBot())scrollEnd();
}
function updStreamText(el,txt){
  if(mdTimer)return;
  mdTimer=requestAnimationFrame(()=>{
    el.body.innerHTML=renderMd(txt);el.body.appendChild(el.cur);
    if(nearBot())scrollEnd();
    mdTimer=null;
  });
}
function updStreamThink(el,txt){
  el.ttx.textContent=txt;
  el.tmt.textContent=txt.trim().split(/\s+/).filter(Boolean).length+' words';
  el.ttx.scrollTop=el.ttx.scrollHeight;
  if(nearBot())scrollEnd();
}

function nearBot(){return chatArea.scrollHeight-chatArea.scrollTop-chatArea.clientHeight<120}
function scrollEnd(){requestAnimationFrame(()=>{chatArea.scrollTop=chatArea.scrollHeight})}

/* ‚ïê‚ïê‚ïê SEND / STREAM with AUTO-CONTINUE ‚ïê‚ïê‚ïê */
async function send(){
  const text=uInp.value.trim();if(!text||sending)return;
  sending=true;lastContState=null;
  const c=cc();if(!c){sending=false;return}
  const model=MODELS.find(x=>x.id===modSel.value);
  const modelId=model?model.id:modSel.value;
  const isThink=model&&model.think;
  c.modelId=modelId;

  const uMsg={role:'user',content:text,ts:Date.now()};
  c.msgs.push(uMsg);c.history.push({role:'user',content:text});
  if(c.msgs.filter(x=>x.role==='user').length===1)c.title=text.length>50?text.slice(0,50)+'‚Ä¶':text;

  const idx=chatArea.querySelectorAll('.msg-row').length;
  appendEl(uMsg,idx,true);
  renderSB();updNav();save();
  uInp.value='';uInp.style.height='auto';
  sendBtn.disabled=true;modSel.disabled=true;

  const el=mkStreamEl(model);
  chatArea.appendChild(el.row);scrollEnd();

  const sendStartTime=Date.now();

  let stallWarnTimer=null;
  function startStallWarn(){
    clearTimeout(stallWarnTimer);
    stallWarnTimer=setTimeout(()=>{
      el.contStatus.style.display='';
      el.contStatus.innerHTML='<div class="cont-ind" style="color:var(--yel)"><span class="pulse" style="background:var(--yel)"></span> Taking longer than usual‚Ä¶</div>';
      scrollEnd();
    },STALL_WARN_MS);
  }
  function clearStallWarn(){
    clearTimeout(stallWarnTimer);
    stallWarnTimer=null;
    if(el.contStatus.innerHTML.includes('Taking longer')){
      el.contStatus.style.display='none';
      el.contStatus.innerHTML='';
    }
  }

  let thinkTxt='',replyTxt='';
  let totalInTok=0,totalOutTok=0,totalCacheRead=0;
  let contCount=0;
  const autoContEnabled=$('autoCont').checked;

  async function doRequest(messages){
    let localIn=0,localOut=0,localCache=0,localStop='';

    const reqBody={model:modelId,max_tokens:128000,messages:messages,stream:true};
    if(isThink)reqBody.thinking={type:'enabled',budget_tokens:100000};

    console.log('[auto-continue] Sending request, messages:',messages.length,'continuation:',contCount);

    startStallWarn();

    try{
      const res=await fetchWithRetry('/.netlify/functions/claude-proxy',{
        method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(reqBody)
      });

      if(!res.ok){
        const ed=await res.json().catch(()=>({}));
        const em=ed.error?.message||ed.error||'HTTP '+res.status;
        throw new Error(em);
      }

      const ct=res.headers.get('content-type')||'';
      if(ct.includes('text/event-stream')&&res.body){
        const reader=res.body.getReader();
        const dec=new TextDecoder();
        let buf='';

        try{
          while(true){
            const{done,value}=await readWithStallTimeout(reader,STREAM_STALL_MS);
            if(done)break;
            startStallWarn();
            buf+=dec.decode(value,{stream:true});
            while(true){
              const nl=buf.indexOf('\n');if(nl===-1)break;
              const line=buf.slice(0,nl).trim();buf=buf.slice(nl+1);
              if(!line||line.startsWith('event:')||!line.startsWith('data:'))continue;
              const ds=line.slice(5).trim();if(!ds||ds==='[DONE]')continue;
              try{
                const ev=JSON.parse(ds);
                switch(ev.type){
                  case'message_start':
                    if(ev.message?.usage){
                      localIn=ev.message.usage.input_tokens||0;
                      if(ev.message.usage.cache_read_input_tokens)localCache=ev.message.usage.cache_read_input_tokens;
                    }
                    if(ev.message?.stop_reason)localStop=ev.message.stop_reason;
                    break;
                  case'content_block_start':
                    if(ev.content_block?.type==='thinking'){el.tk.style.display=''}
                    break;
                  case'content_block_delta':
                    if(ev.delta?.type==='thinking_delta'){thinkTxt+=ev.delta.thinking;updStreamThink(el,thinkTxt)}
                    else if(ev.delta?.type==='text_delta'){replyTxt+=ev.delta.text;updStreamText(el,replyTxt)}
                    break;
                  case'content_block_stop':break;
                  case'message_delta':
                    if(ev.usage)localOut=ev.usage.output_tokens||0;
                    if(ev.delta?.stop_reason)localStop=ev.delta.stop_reason;
                    else if(ev.stop_reason)localStop=ev.stop_reason;
                    console.log('[auto-continue] message_delta ‚Äî stop_reason:',localStop,'outTok:',localOut);
                    break;
                  case'message_stop':
                    if(ev.delta?.stop_reason)localStop=ev.delta.stop_reason;
                    else if(ev.stop_reason)localStop=ev.stop_reason;
                    break;
                  case'error':throw new Error(ev.error?.message||'Stream error');
                }
              }catch(pe){if(pe.message&&(pe.message.includes('Stream error')||pe.message.includes('error')))throw pe}
            }
          }
        }catch(streamErr){
          if(streamErr.message&&streamErr.message.includes('Stream stalled')&&(replyTxt.length>200||thinkTxt.length>200)){
            console.warn('[stream] Stall with partial content, treating as max_tokens');
            localStop='max_tokens';
          }else{
            throw streamErr;
          }
        }
      } else {
        const data=await res.json();
        console.log('[auto-continue] Non-stream response, stop_reason:', data.stop_reason);
        if(data.content&&Array.isArray(data.content)){
          for(const b of data.content){
            if(b.type==='thinking')thinkTxt+=b.thinking;
            else if(b.type==='text')replyTxt+=b.text;
          }
        }
        if(data.usage){
          localIn=data.usage.input_tokens||0;
          localOut=data.usage.output_tokens||0;
          if(data.usage.cache_read_input_tokens)localCache=data.usage.cache_read_input_tokens;
        }
        localStop=data.stop_reason||'';
        if(thinkTxt){el.tk.style.display='';updStreamThink(el,thinkTxt)}
      }

      flushMd(el,replyTxt);

      if(!localStop&&replyTxt.length>200&&looksIncomplete(replyTxt)){
        console.log('[auto-continue] No stop_reason but heuristic detected truncation');
        localStop='max_tokens';
      }
      /* Heuristic: thinking was cut off (substantial thinking, little/no reply) */
      if(!localStop&&thinkTxt.length>1000&&replyTxt.length<50){
        console.log('[auto-continue] No stop_reason but thinking cut off heuristic triggered');
        localStop='max_tokens';
      }

      console.log('[auto-continue] Request done ‚Äî stop:',localStop,'in:',localIn,'out:',localOut,'replyLen:',replyTxt.length,'thinkLen:',thinkTxt.length);
      return{inTok:localIn,outTok:localOut,cacheRead:localCache,stopReason:localStop};

    }finally{
      clearStallWarn();
    }
  }

  try{
    trimHistory(c.history);

    let result=await doRequest(c.history);
    totalInTok+=result.inTok;totalOutTok+=result.outTok;totalCacheRead+=result.cacheRead;

    /* ‚îÄ‚îÄ Auto-continue loop ‚îÄ‚îÄ */
    while(autoContEnabled&&contCount<MAX_CONT){
      if(Date.now()-sendStartTime>OVERALL_TIMEOUT_MS){
        console.warn('[send] Overall timeout reached ('+Math.round(OVERALL_TIMEOUT_MS/1000)+'s), stopping auto-continue');
        el.contStatus.style.display='';
        el.contStatus.innerHTML='<div class="cont-ind" style="color:var(--yel)">‚è≥ Overall timeout reached, stopping auto-continue</div>';
        break;
      }

      /* shouldContinue: covers both reply truncation AND thinking truncation */
      const shouldContinue=result.stopReason==='max_tokens'||
        (!result.stopReason&&replyTxt.length>500&&looksIncomplete(replyTxt))||
        (!result.stopReason&&thinkTxt.length>1000&&replyTxt.length<50);
      if(!shouldContinue)break;

      if(!result.stopReason&&!looksIncomplete(replyTxt)&&!(thinkTxt.length>1000&&replyTxt.length<50)){
        console.log('[auto-continue] No stop_reason and text looks complete, stopping');
        break;
      }

      contCount++;
      console.log('[auto-continue] Starting continuation',contCount,'/',MAX_CONT);

      /* ‚îÄ‚îÄ 1-minute cooldown with countdown ‚îÄ‚îÄ */
      el.contStatus.style.display='';
      const cdSec=Math.ceil(CONT_DELAY_MS/1000);
      let cdRem=cdSec;
      el.contStatus.innerHTML='<div class="cont-ind"><span class="pulse"></span> Cooldown '+cdRem+'s ‚Äî then auto-continue ('+contCount+'/'+MAX_CONT+')</div>';
      scrollEnd();
      const cdIntv=setInterval(()=>{
        cdRem--;
        if(cdRem<=0){
          clearInterval(cdIntv);
          el.contStatus.innerHTML='<div class="cont-ind"><span class="pulse"></span> Auto-continuing‚Ä¶ ('+contCount+'/'+MAX_CONT+')</div>';
          scrollEnd();
        }else{
          el.contStatus.innerHTML='<div class="cont-ind"><span class="pulse"></span> Cooldown '+cdRem+'s ‚Äî then auto-continue ('+contCount+'/'+MAX_CONT+')</div>';
        }
      },1000);

      await sleep(CONT_DELAY_MS);
      clearInterval(cdIntv);

      if(thinkTxt&&isThink){
        thinkTxt+='\n\n‚îÄ‚îÄ‚îÄ Continuation '+contCount+' ‚îÄ‚îÄ‚îÄ\n\n';
        updStreamThink(el,thinkTxt);
      }

      /* Build continuation messages ‚Äî handle empty replyTxt (thinking cutoff) */
      let contMsgs;
      if(replyTxt.trim()){
        contMsgs=[
          ...c.history,
          {role:'assistant',content:replyTxt},
          {role:'user',content:'Continue from where you left off. Do not repeat any content already written.'}
        ];
      } else {
        /* Thinking was cut off before any reply text ‚Äî retry original messages */
        contMsgs=[...c.history];
      }
      trimHistory(contMsgs);

      const textBefore=replyTxt.length;
      const thinkBefore=thinkTxt.length;
      try{
        result=await doRequest(contMsgs);
        totalInTok+=result.inTok;totalOutTok+=result.outTok;totalCacheRead+=result.cacheRead;
      }catch(contErr){
        console.warn('[auto-continue] Continuation',contCount,'failed:',contErr.message);
        el.contStatus.style.display='';
        el.contStatus.innerHTML='<div class="cont-ind" style="color:var(--red)">‚ö† Auto-continue stopped: '+esc(contErr.message)+'</div>';
        break;
      }

      el.contStatus.style.display='none';

      /* Progress check: consider both reply text AND thinking text growth */
      if(replyTxt.length<=textBefore&&thinkTxt.length<=thinkBefore){
        console.log('[auto-continue] No new content in continuation, stopping');
        break;
      }
    }

    /* ‚îÄ‚îÄ Finalize ‚îÄ‚îÄ */
    el.cur.remove();
    el.contStatus.style.display='none';
    if(thinkTxt){el.tlb.textContent='Thinking Process';updStreamThink(el,thinkTxt)}else{el.tk.style.display='none'}
    el.body.innerHTML=renderMd(replyTxt||'(empty response)');

    el.cpBtn.style.display='';
    rawContentMap.set(el.row,replyTxt||'(empty response)');

    const usage={input_tokens:totalInTok,output_tokens:totalOutTok};
    if(totalCacheRead)usage.cache_read=totalCacheRead;
    c.tokIn+=totalInTok;c.tokOut+=totalOutTok;

    if(totalInTok||totalOutTok){
      el.ft.style.display='';
      el.ft.innerHTML='<span class="tk">‚Üë in <span class="n">'+totalInTok.toLocaleString()+'</span></span><span class="tk">‚Üì out <span class="n">'+totalOutTok.toLocaleString()+'</span></span>';
      if(totalCacheRead)el.ft.innerHTML+='<span class="tk">üì¶ cache <span class="n">'+totalCacheRead.toLocaleString()+'</span></span>';
      if(contCount>0)el.ft.innerHTML+='<span class="cont-badge">üîÑ '+contCount+' continuation'+(contCount>1?'s':'')+'</span>';
    }

    const stillIncomplete=(result.stopReason==='max_tokens')||(looksIncomplete(replyTxt));
    if(stillIncomplete){
      const mcBtn=document.createElement('button');mcBtn.className='cont-btn';mcBtn.innerHTML='‚Üª Continue';
      mcBtn.onclick=()=>manualContinue();
      el.ft.style.display='';
      el.ft.appendChild(mcBtn);
      lastContState={chatId:c.id,replyTxt,thinkTxt,totalInTok,totalOutTok,totalCacheRead,contCount,el,model,modelId,isThink};
    } else {
      lastContState=null;
    }

    updCost();

    const aMsg={role:'assistant',content:replyTxt||'(empty response)',thinking:thinkTxt||null,usage,modelLabel:model?.label,ts:Date.now(),continuations:contCount};
    c.msgs.push(aMsg);c.history.push({role:'assistant',content:replyTxt||''});

  }catch(err){
    el.cur.remove();el.tk.style.display='none';el.contStatus.style.display='none';
    if(replyTxt){
      el.body.innerHTML=renderMd(replyTxt)+'<p class="err-text" style="margin-top:12px">‚ö† Error: '+esc(err.message)+'</p>';
      rawContentMap.set(el.row,replyTxt);
      el.cpBtn.style.display='';
      c.msgs.push({role:'assistant',content:replyTxt,thinking:thinkTxt||null,modelLabel:model?.label,ts:Date.now(),usage:{input_tokens:totalInTok,output_tokens:totalOutTok}});
      c.history.push({role:'assistant',content:replyTxt});
    }else{
      el.body.innerHTML='<span class="err-text">Error: '+esc(err.message)+'</span>';
      c.msgs.push({role:'assistant',content:'Error: '+err.message,isError:true,ts:Date.now()});
    }
  }

  updNav();save();
  clearTimeout(stallWarnTimer);
  sending=false;sendBtn.disabled=false;modSel.disabled=false;
  uInp.focus();
}

/* ‚ïê‚ïê‚ïê MANUAL CONTINUE ‚ïê‚ïê‚ïê */
async function manualContinue(){
  if(sending||!lastContState)return;
  const st=lastContState;
  const c=gc(st.chatId);if(!c)return;
  sending=true;sendBtn.disabled=true;modSel.disabled=true;

  let{replyTxt,thinkTxt,totalInTok,totalOutTok,totalCacheRead,contCount,el,model,modelId,isThink}=st;
  lastContState=null;

  let stallWarnTimer=null;
  function startStallWarn(){
    clearTimeout(stallWarnTimer);
    stallWarnTimer=setTimeout(()=>{
      el.contStatus.style.display='';
      el.contStatus.innerHTML='<div class="cont-ind" style="color:var(--yel)"><span class="pulse" style="background:var(--yel)"></span> Taking longer than usual‚Ä¶</div>';
      scrollEnd();
    },STALL_WARN_MS);
  }
  function clearStallWarn(){
    clearTimeout(stallWarnTimer);
    stallWarnTimer=null;
    if(el.contStatus.innerHTML.includes('Taking longer')){
      el.contStatus.style.display='none';
      el.contStatus.innerHTML='';
    }
  }

  const oldBtn=el.ft.querySelector('.cont-btn');if(oldBtn)oldBtn.remove();

  const cur=document.createElement('span');cur.className='cursor';
  el.body.appendChild(cur);
  el.cur=cur;

  contCount++;
  el.contStatus.style.display='';
  el.contStatus.innerHTML='<div class="cont-ind"><span class="pulse"></span> Manual continue‚Ä¶ ('+contCount+')</div>';
  scrollEnd();

  if(thinkTxt&&isThink){
    thinkTxt+='\n\n‚îÄ‚îÄ‚îÄ Continuation '+contCount+' ‚îÄ‚îÄ‚îÄ\n\n';
    updStreamThink(el,thinkTxt);
  }

  if(c.history.length&&c.history[c.history.length-1].role==='assistant'){
    c.history.pop();
  }
  if(c.msgs.length&&c.msgs[c.msgs.length-1].role==='assistant'){
    c.msgs.pop();
  }

  /* Build continuation messages ‚Äî handle empty replyTxt */
  let contMsgs;
  if(replyTxt.trim()){
    contMsgs=[
      ...c.history,
      {role:'assistant',content:replyTxt},
      {role:'user',content:'Continue from where you left off. Do not repeat any content already written.'}
    ];
  } else {
    contMsgs=[...c.history];
  }
  trimHistory(contMsgs);

  const reqBody={model:modelId,max_tokens:128000,messages:contMsgs,stream:true};
  if(isThink)reqBody.thinking={type:'enabled',budget_tokens:100000};

  let localIn=0,localOut=0,localCache=0,localStop='';

  try{
    startStallWarn();

    const res=await fetchWithRetry('/.netlify/functions/claude-proxy',{
      method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(reqBody)
    });
    if(!res.ok){const ed=await res.json().catch(()=>({}));throw new Error(ed.error?.message||ed.error||'HTTP '+res.status)}

    const ct=res.headers.get('content-type')||'';
    if(ct.includes('text/event-stream')&&res.body){
      const reader=res.body.getReader();
      const dec=new TextDecoder();
      let buf='';

      try{
        while(true){
          const{done,value}=await readWithStallTimeout(reader,STREAM_STALL_MS);
          if(done)break;
          startStallWarn();
          buf+=dec.decode(value,{stream:true});
          while(true){
            const nl=buf.indexOf('\n');if(nl===-1)break;
            const line=buf.slice(0,nl).trim();buf=buf.slice(nl+1);
            if(!line||line.startsWith('event:')||!line.startsWith('data:'))continue;
            const ds=line.slice(5).trim();if(!ds||ds==='[DONE]')continue;
            try{
              const ev=JSON.parse(ds);
              switch(ev.type){
                case'message_start':
                  if(ev.message?.usage){localIn=ev.message.usage.input_tokens||0;if(ev.message.usage.cache_read_input_tokens)localCache=ev.message.usage.cache_read_input_tokens}
                  break;
                case'content_block_start':if(ev.content_block?.type==='thinking')el.tk.style.display='';break;
                case'content_block_delta':
                  if(ev.delta?.type==='thinking_delta'){thinkTxt+=ev.delta.thinking;updStreamThink(el,thinkTxt)}
                  else if(ev.delta?.type==='text_delta'){replyTxt+=ev.delta.text;updStreamText(el,replyTxt)}
                  break;
                case'message_delta':
                  if(ev.usage)localOut=ev.usage.output_tokens||0;
                  if(ev.delta?.stop_reason)localStop=ev.delta.stop_reason;
                  else if(ev.stop_reason)localStop=ev.stop_reason;
                  break;
                case'message_stop':
                  if(ev.delta?.stop_reason)localStop=ev.delta.stop_reason;
                  else if(ev.stop_reason)localStop=ev.stop_reason;
                  break;
                case'error':throw new Error(ev.error?.message||'Stream error');
              }
            }catch(pe){if(pe.message&&(pe.message.includes('Stream error')||pe.message.includes('error')))throw pe}
          }
        }
      }catch(streamErr){
        if(streamErr.message&&streamErr.message.includes('Stream stalled')){
          console.warn('[manual-continue] Stream stalled, preserving partial content');
          localStop='max_tokens';
        }else{
          throw streamErr;
        }
      }
    } else {
      const data=await res.json();
      if(data.content&&Array.isArray(data.content)){
        for(const b of data.content){if(b.type==='thinking')thinkTxt+=b.thinking;else if(b.type==='text')replyTxt+=b.text}
      }
      if(data.usage){localIn=data.usage.input_tokens||0;localOut=data.usage.output_tokens||0;if(data.usage.cache_read_input_tokens)localCache=data.usage.cache_read_input_tokens}
      localStop=data.stop_reason||'';
    }

    if(mdTimer){cancelAnimationFrame(mdTimer);mdTimer=null}

    totalInTok+=localIn;totalOutTok+=localOut;totalCacheRead+=localCache;

  }catch(err){
    console.warn('[manual-continue] Error:',err.message);
    el.contStatus.style.display='';
    el.contStatus.innerHTML='<div class="cont-ind" style="color:var(--red)">‚ö† Continue failed: '+esc(err.message)+'</div>';
  }

  clearStallWarn();

  cur.remove();
  if(!el.contStatus.querySelector('[style*="red"]')){
    el.contStatus.style.display='none';
  }
  if(thinkTxt){el.tlb.textContent='Thinking Process';updStreamThink(el,thinkTxt)}else{el.tk.style.display='none'}
  el.body.innerHTML=renderMd(replyTxt||'(empty response)');
  el.cpBtn.style.display='';
  rawContentMap.set(el.row,replyTxt||'(empty response)');

  const usage={input_tokens:totalInTok,output_tokens:totalOutTok};
  if(totalCacheRead)usage.cache_read=totalCacheRead;
  c.tokIn=totalInTok;c.tokOut=totalOutTok;

  el.ft.innerHTML='<span class="tk">‚Üë in <span class="n">'+totalInTok.toLocaleString()+'</span></span><span class="tk">‚Üì out <span class="n">'+totalOutTok.toLocaleString()+'</span></span>';
  if(totalCacheRead)el.ft.innerHTML+='<span class="tk">üì¶ cache <span class="n">'+totalCacheRead.toLocaleString()+'</span></span>';
  if(contCount>0)el.ft.innerHTML+='<span class="cont-badge">üîÑ '+contCount+' continuation'+(contCount>1?'s':'')+'</span>';
  el.ft.style.display='';

  if(!localStop)localStop=(looksIncomplete(replyTxt)?'max_tokens':'');
  if(localStop==='max_tokens'||looksIncomplete(replyTxt)){
    const mcBtn=document.createElement('button');mcBtn.className='cont-btn';mcBtn.innerHTML='‚Üª Continue';
    mcBtn.onclick=()=>manualContinue();
    el.ft.appendChild(mcBtn);
    lastContState={chatId:c.id,replyTxt,thinkTxt,totalInTok,totalOutTok,totalCacheRead,contCount,el,model,modelId,isThink};
  }

  updCost();
  const aMsg={role:'assistant',content:replyTxt||'(empty response)',thinking:thinkTxt||null,usage,modelLabel:model?.label,ts:Date.now(),continuations:contCount};
  c.msgs.push(aMsg);c.history.push({role:'assistant',content:replyTxt||''});

  updNav();save();

  clearTimeout(stallWarnTimer);
  sending=false;sendBtn.disabled=false;modSel.disabled=false;
  uInp.focus();
}

/* ‚ïê‚ïê‚ïê INPUT ‚ïê‚ïê‚ïê */
uInp.addEventListener('input',()=>{uInp.style.height='auto';uInp.style.height=Math.min(uInp.scrollHeight,150)+'px'});
uInp.addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();send()}});

/* ‚ïê‚ïê‚ïê SIDEBAR TOGGLE ‚ïê‚ïê‚ïê */
function toggleSB(){sidebar.classList.toggle('open');sbOv.classList.toggle('act')}
function closeSB(){sidebar.classList.remove('open');sbOv.classList.remove('act')}

/* ‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê */
(function(){
  load();
  if(chats.length===0)newChat();
  else{if(!curId||!gc(curId))curId=chats[0].id;const c=cc();if(c)modSel.value=c.modelId;updPrice()}
  renderSB();renderMsgs();updNav();
})();
</script>
</body>
</html>

